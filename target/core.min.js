var __awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(n,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))};class Core{constructor(e){Credentials.publicId=e,Credentials.attemptLoadFromLocalStorage()}getUser(){return new User}login(e,t=["offline","payment/autofill","profile/list","profile/link","defaultScope"],o,r){return __awaiter(this,void 0,void 0,(function*(){t.includes("defaultScope")&&Credentials.publicId&&!t.includes(`network/${Credentials.publicId}`)&&t.push(`network/${Credentials.publicId}`),t=t.filter((e=>"defaultScope"!==e));const n=yield LoginHelper.login(e,t,o?"code":"token",Credentials.publicId,o,r,Credentials.userToken?Credentials.userToken.accessToken:null);return Credentials.userToken||(Credentials.userToken=n,Credentials.saveUserToken()),this}))}logout(){Credentials.clear()}}try{module.exports=Core}catch(e){}class Call{static commit(e,t,o=!1){return __awaiter(this,void 0,void 0,(function*(){let r={method:"GET",headers:new Headers({Accept:"application/json"})};if(Credentials.userToken&&!o){const e=yield Credentials.userToken.use();e&&(Credentials.userToken=e,Credentials.saveUserToken()),r.headers=new Headers({Accept:"application/json",Authorization:`Bearer ${Credentials.userToken.accessToken}`})}t&&(r={method:"POST",headers:new Headers({Accept:"application/json","Content-type":"application/json",Authorization:`Bearer ${Credentials.userToken.accessToken}`}),body:JSON.stringify(t)});const n=yield fetch(`https://api.purecore.io${e}`,r);if(n.ok)return yield n.json();throw new Error(yield n.text())}))}}class Credentials{static saveUserToken(){Credentials.userToken.refreshToken&&(localStorage.setItem(btoa("purecore-access-token"),btoa(JSON.stringify({accessToken:Credentials.userToken.accessToken,expires:Credentials.userToken.expires}))),Credentials.userToken.refreshToken&&localStorage.setItem(btoa("purecore-refresh-token"),btoa(JSON.stringify({refreshToken:Credentials.userToken.refreshToken}))))}static attemptLoadFromLocalStorage(){if(localStorage){const e=localStorage.getItem(btoa("purecore-access-token")),t=localStorage.getItem(btoa("purecore-refresh-token"));if(e&&t){const o=JSON.parse(atob(e));Credentials.userToken=new Token(o.accessToken,new Date(o.expires),JSON.parse(atob(t)).refreshToken)}}}static clear(){Credentials.publicId=void 0,Credentials.userToken=void 0,localStorage.removeItem(btoa("purecore-access-token")),localStorage.removeItem(btoa("purecore-refresh-token"))}}class LoginHelper{static login(e,t,o,r,n,i,s){return new Promise(((a,l)=>{if(null!=window)try{null!=LoginHelper.activeWindow&&LoginHelper.activeWindow.close();let c=700,d=500;const u=window.top.outerHeight/2+window.top.screenY-c/2,p=window.top.outerWidth/2+window.top.screenX-d/2;let h=window.open(`https://api.purecore.io/oauth/authorize/${e}/?scope=${t.join(" ")}&response_type=${o}${null!=r?`&client_id=${r}`:""}${null!=n?`&redirect_uri=${n}`:""}${null!=i?`&state=${i}`:""}${null!=s?`&access_token=${s}`:""}`,"Login",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${d}, height=${c}, top=${u}, left=${p}`);LoginHelper.activeWindow=h;let f=!0,k=null;window.addEventListener("message",(e=>{if("https://api.purecore.io"===e.origin&&"login"===e.data.message)f&&(k=Token.fromObject(e.data.data),h.closed||(h.close(),LoginHelper.activeWindow=null),f=!1),a(k)}),!1);let w=setInterval((()=>{null!=LoginHelper.activeWindow&&LoginHelper.activeWindow.closed&&(LoginHelper.activeWindow=null),h.closed&&null==k&&(f=!1,clearInterval(w),l(new Error("The popup was closed before any session was retrieved")))}),50)}catch(e){l(e)}else l(new Error("In order to create a login popup, you must be executing purecore from a Document Object Model"))}))}}class Token{constructor(e,t,o){this.accessToken=e,this.expires=t,this.refreshToken=o}static fromObject(e){return new Token(e.access_token,new Date(e.expires),e.refresh_token)}use(){return __awaiter(this,void 0,void 0,(function*(){if((new Date).getTime()>this.expires.getTime()){if(this.refreshToken){let e={grant_type:"refresh_token",refresh_token:this.refreshToken};return Credentials.publicId&&(e.client_id=Credentials.publicId),Token.fromObject(yield Call.commit("/oauth/token/",e,!0))}throw new Error("expired access token")}return null}))}}class Profile{constructor(e,t,o,r){this.service=e,this.id=t,this.name=o,this.email=r}static fromObject(e){return new Profile(e.service,e.id,e.name,e.email)}}class User{getProfiles(){return __awaiter(this,void 0,void 0,(function*(){const e=yield Call.commit("/rest/3/user/profile/list/"),t=[];return e.forEach((e=>{t.push(Profile.fromObject(e))})),t}))}}