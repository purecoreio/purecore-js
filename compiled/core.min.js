var Param,Game,CoreInstanceType,Platform,__awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))};class Core{constructor(e,t){if(null==Core.context&&(Core.context=new Context),null==t||0==t){let e=location;Core.dev=!!e&&("localhost"===location.hostname||"127.0.0.1"===location.hostname)}else Core.dev=t;null==Core.keychain&&(Core.keychain=new Keychain),null!=e&&Core.keychain.addMethod(Keychain.getMethod(e))}getLoginManager(){return new LoginHelper}static getContext(){return Core.context}static getKeychain(){return Core.keychain}static getInstance(e){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Instance,e).commit("instance/get/").then((e=>Instance.fromObject(e)))}))}static getNetwork(e){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Network,e).commit("network/get/").then((e=>Network.fromObject(e)))}))}static getAuth(){let e=null,t=Core.keychain.getMethods();for(let r=0;r<t.length;r++){const o=t[r];if(null==e)e=o;else if(o instanceof CoreSession&&e instanceof Key){e=o;break}}return e}static addAuth(e){Core.keychain.addMethod(e)}getPlayer(){return null!=Core.keychain.getSession()?Core.keychain.getSession().getPlayer():null}}try{module.exports=Core}catch(e){}class Keychain{constructor(){this.authMethods=new Array}addMethod(e){this.authMethods.push(e)}getSession(){for(let e=0;e<this.authMethods.length;e++){const t=this.authMethods[e];if(t instanceof CoreSession)return t}return null}getMethods(){return this.authMethods}removeSessions(){let e=new Array;for(let t=0;t<this.authMethods.length;t++){const r=this.authMethods[t];r instanceof CoreSession||e.push(r)}this.authMethods=e}static getMethod(e){return"string"==typeof e?new Key(e):"object"==typeof e?CoreSession.fromObject(e):void 0}}class LoginHelper{constructor(e=!0){if(this.autoLogin=e,this.loggedIn=!1,this.autoLogin)try{this.loadSession(),this.loggedIn=!0}catch(e){}Core.getAuth()instanceof CoreSession&&(this.loggedIn=!0)}isLoggedIn(){return this.loggedIn}loadSession(){let e=CoreSession.load();return Core.addAuth(e),e}logout(){null!=localStorage.getItem(btoa("purecore-"+window.location.hostname+"l"))&&localStorage.removeItem(btoa("purecore-"+window.location.hostname+"l")),null!=localStorage.getItem(btoa("purecore-"+window.location.hostname+"d"))&&localStorage.removeItem(btoa("purecore-"+window.location.hostname+"d")),null!=localStorage.getItem(btoa("purecore-"+window.location.hostname+"h"))&&localStorage.removeItem(btoa("purecore-"+window.location.hostname+"h")),Core.getKeychain().removeSessions(),this.loggedIn=!1}login(e){return new Promise(((t,r)=>{if(e=Util.platformVal(e),null!=window)try{null!=LoginHelper.activeWindow&&LoginHelper.activeWindow.close();let o=600,n=400;const i=window.top.outerHeight/2+window.top.screenY-o/2,a=window.top.outerWidth/2+window.top.screenX-n/2;let s=window.open(this.getURL(e),"Login",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${n}, height=${o}, top=${i}, left=${a}`);LoginHelper.activeWindow=s;let c=!0,l=null;window.addEventListener("message",(e=>{if("https://api.purecore.io"===e.origin)switch(e.data.message){case"login":c&&(l=Keychain.getMethod(e.data.data),Core.addAuth(l),s.closed||(s.close(),LoginHelper.activeWindow=null),c=!1),this.autoLogin&&l instanceof CoreSession&&(l.save(),this.loggedIn=!0),t(l)}}),!1);let h=setInterval((()=>{null!=LoginHelper.activeWindow&&LoginHelper.activeWindow.closed&&(LoginHelper.activeWindow=null),s.closed&&null==l&&(c=!1,clearInterval(h),r(new Error("The popup was closed before any session was retrieved")))}),50)}catch(e){r(e)}else r(new Error("In order to create a login popup, you must be executing purecore from a Document Object Model"))}))}getURL(e){let t="";switch(e){case Platform.Stadia:t+="google";break;case Platform.Steam:t+="steam";break;case Platform.Xbox:t+="microsoft";break;case Platform.Discord:t+="discord";break;default:throw new Error("Unsupported login method")}return`https://api.purecore.io/login/${t}/`}}class Key{constructor(e,t,r,o,n,i){this.hash=e,this.id=t,this.type=r,this.restrict=o,this.allowedReferrers=n,this.allowedRegions=i}getCredentials(){return this.hash}getParam(){return Param.Hash}static fromObject(e){if("hash"in e){let t=new Key(String(e.hash));if("id"in e&&(t.id=String(e.id)),"restrict"in e&&(t.restrict=Boolean(e.restrict)),"allowedReferrers"in e&&(t.allowedReferrers=new Array,Array.isArray(e.allowedReferrers)))for(let r=0;r<e.allowedReferrers.length;r++){const o=e.allowedReferrers[r];t.allowedReferrers.push(RefererRestriction.fromObject(o))}if("allowedRegions"in e&&(t.allowedRegions=new Array,Array.isArray(e.allowedRegions)))for(let r=0;r<e.allowedRegions.length;r++){const o=e.allowedRegions[r];t.allowedRegions.push(RegionRestriction.fromObject(o))}return t}throw new MissingProp("hash")}}class RefererRestriction{constructor(e,t,r){this.index=e,this.domain=t,this.ip=r}static fromObject(e){let t=new RefererRestriction;return t.index=Number(e.index),t.domain=String(e.domain),t.ip=String(e.ip),t}}class RegionRestriction{constructor(e,t,r,o){this.index=e,this.country=t,this.state=r,this.city=o}static fromObject(e){let t=new RegionRestriction;return t.index=Number(e.index),t.country=String(e.country),t.state=String(e.state),t.city=String(e.city),t}}class CoreSession{constructor(e,t,r,o,n,i,a){this.owner=e,this.location=t,this.device=r,this.usage=o,this.id=n,this.hash=i,this.network=a}getCredentials(){return this.hash}getParam(){return Param.Hash}asObject(){return{owner:this.owner.asObject(),location:this.location.asObject(),device:this.device.asObject(),usage:this.usage.asObject(),id:this.id,hash:this.hash,network:null==this.network?null:this.network.asObject()}}save(){if(!localStorage)throw new Error("Local storage unavailable");{let e=Math.floor(128*Math.random()),t=btoa(Util.generateGibberish(256+e)+this.hash+Util.generateGibberish(256+e)),r=Util.shortLengthToLong(e),o=this.asObject();delete o.hash,localStorage.setItem(btoa("purecore-"+window.location.hostname+"h"),t),localStorage.setItem(btoa("purecore-"+window.location.hostname+"d"),btoa(JSON.stringify(o))),localStorage.setItem(btoa("purecore-"+window.location.hostname+"l"),r)}}static load(){let e=localStorage.getItem(btoa("purecore-"+window.location.hostname+"h")),t=localStorage.getItem(btoa("purecore-"+window.location.hostname+"d")),r=localStorage.getItem(btoa("purecore-"+window.location.hostname+"l"));if(null!=e){if(null!=r){if(null!=t){let o=Util.longLengthToShort(r),n=atob(e),i=n.substr(256+o,n.length-2*(256+o)),a=JSON.parse(atob(t));return a.hash=i,CoreSession.fromObject(Keychain.getMethod(a))}throw localStorage.removeItem(btoa("purecore-"+window.location.hostname+"h")),localStorage.removeItem(btoa("purecore-"+window.location.hostname+"l")),new Error("Missing non-sensitive data")}throw localStorage.removeItem(btoa("purecore-"+window.location.hostname+"h")),new Error("No hash length found")}throw null!=r&&localStorage.removeItem(btoa("purecore-"+window.location.hostname+"l")),null!=t&&localStorage.removeItem(btoa("purecore-"+window.location.hostname+"d")),new Error("No hash found")}static fromObject(e){let t=new CoreSession;return"owner"in e&&(t.owner=Player.fromObject(e.owner)),"location"in e&&(t.location=SessionLocation.fromObject(e.location)),"device"in e&&(t.device=SessionDevice.fromObject(e.device)),"usage"in e&&(t.usage=SessionUsage.fromObject(e.usage)),"id"in e&&(t.id=String(e.id)),"hash"in e&&(t.hash=String(e.hash)),"network"in e&&(null!=e.network?t.network=Network.fromObject(e.network):t.network=null),t}getPlayer(){return this.owner}}class SessionDevice{constructor(e,t,r,o){this.os=e,this.device=t,this.brand=r,this.model=o}asObject(){return JSON.parse(JSON.stringify(this))}static fromObject(e){let t=new SessionDevice;return t.os=String(e.os),t.device=String(e.device),t.brand=String(e.brand),t.model=String(e.model),t}}class SessionLocation{constructor(e,t,r){this.city=e,this.state=t,this.country=r}asObject(){return JSON.parse(JSON.stringify(this))}static fromObject(e){let t=new SessionLocation;return t.city=String(e.city),t.state=String(e.state),t.country=String(e.country),t}}class SessionUsage{constructor(e,t){this.creation=e,this.uses=t}asObject(){let e=JSON.parse(JSON.stringify(this));return e.creation=Util.epoch(this.creation),e}static fromObject(e){let t=new SessionUsage;return t.creation=Util.date(e.creation),t.uses=Number(e.uses),t}}class Call{constructor(){this.baseURL="https://api.purecore.io/rest/3",this.paramList=new Array}addParam(e,t){return this.paramList.push(new CallParam(e,t)),this}commit(e){return __awaiter(this,void 0,void 0,(function*(){let t={};for(let e=0;e<this.paramList.length;e++){const r=this.paramList[e];t[r.param]=r.value}let r=Core.getAuth();null!=r&&(t[r.getParam()]=r.getCredentials());let o=Call.formatEndpoint(e);const n=this.baseURL+o+"?"+Object.keys(t).filter((e=>t.hasOwnProperty(e))).map((e=>encodeURIComponent(e)+"="+encodeURIComponent(t[e]))).join("&");if(Core.dev){var i=t;for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&e==r.getParam()&&(i[e]="***");console.log(this.baseURL+o,i)}return new Promise(((e,t)=>fetch(n,{method:"POST"}).then((e=>e.json())).then((t=>{if("error"in t)throw new Error(t.error+". "+t.msg);e(t)})).catch((e=>t(e)))))}))}static formatEndpoint(e){return(e.startsWith("/")?"":"/")+e+(e.endsWith("/")?"":"/")}}class CallParam{constructor(e,t){this.param=e,this.value=t}}!function(e){e.Key="k",e.Hash="h",e.Session="ses",e.Code="c",e.PaymentHash="ph",e.Bank="b",e.Description="desc",e.Name="nm",e.Platform="plt",e.Cname="cnm",e.Game="gme",e.PlatformId="plid",e.PlatformName="plnm",e.Quantity="qty",e.Value="val",e.Ip="ip",e.DeviceFingerprint="dv",e.ForumCategory="fc",e.ForumEmote="fe",e.ForumObject="fo",e.ForumOpinion="fop",e.ForumPost="fp",e.ForumReaction="fr",e.ForumReply="frp",e.ForumSection="fs",e.Connection="cn",e.Connections="cs",e.Command="cmd",e.CommandExecution="cex",e.EnvSource="es",e.Host="ht",e.Image="hi",e.ImageEnv="hie",e.HostTemplate="htt",e.Instance="i",e.Instances="is",e.Network="n",e.Server="s",e.Servers="ss",e.ServerGroup="sg",e.KeyId="kid",e.Machine="m",e.Notification="not",e.Payment="p",e.Discount="d",e.Discounts="ds",e.StoreItem="si",e.StoreItems="sis",e.StoreParam="sp",e.StoreParamResponse="spr",e.StoreParamResponses="sprs",e.Perk="pk",e.Perks="pks",e.StoreCategory="sc",e.Punishment="pn",e.Appeal="a",e.Report="r",e.Offence="o",e.Offences="os",e.PunishmentAction="pa",e.VotingSite="vs",e.Ticket="t",e.TicketCategory="tc",e.TicketReply="tr",e.Player="pl",e.Profile="pp",e.NetworkPlayer="np"}(Param||(Param={}));class MissingProp extends Error{constructor(e){super(e),this.name="MissingProp"}}!function(e){e[e.Minecraft=0]="Minecraft",e[e.MinecraftBedrock=1]="MinecraftBedrock",e[e.SpaceEngineers=2]="SpaceEngineers",e[e.Unknown=-1]="Unknown"}(Game||(Game={}));class Instance{constructor(e,t,r){this.id=e,this.name=t,this.type=r}static fromObject(e){let t=new Instance;return t.id=String(e.id),t.name=String(e.name),t.type=Number(e.type),t}asNetwork(){return new Network(this.id,this.name,Game.Unknown,Platform.Unknown)}delete(){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Instance,this.id).commit("instance/delete").then((()=>{}))}))}}!function(e){e[e.Network=0]="Network",e[e.Server=1]="Server"}(CoreInstanceType||(CoreInstanceType={}));class Network{constructor(e,t,r,o){this.id=e,this.name=t,this.game=r,this.platform=o}asObject(){return JSON.parse(JSON.stringify(this))}static fromObject(e){let t=new Network;return t.name=String(e.name),t.id=String(e.id),t.game=Number(e.game),t.platform=Number(e.platform),t}asInstance(){return new Instance(this.id,this.name,CoreInstanceType.Network)}getServers(){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Network,this.id).commit("instance/group/list").then((e=>{let t=new Array;if(Array.isArray(e)){for(let r=0;r<e.length;r++){const o=e[r];t.push(ServerGroupList.fromObject(o))}return t}throw new Error("Invalid result")}))}))}createServerGroup(e){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Network,this.id).addParam(Param.Name,e).commit("instance/group/create").then((e=>ServerGroup.fromObject(e)))}))}delete(){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Instance,this.id).commit("instance/delete").then((()=>{}))}))}}!function(e){e[e.Unknown=-1]="Unknown",e[e.Mojang=0]="Mojang",e[e.Xbox=1]="Xbox",e[e.Steam=2]="Steam",e[e.Stadia=3]="Stadia",e[e.EpicGames=4]="EpicGames",e[e.Discord=5]="Discord"}(Platform||(Platform={}));class Server{constructor(e,t,r,o){this.network=e,this.id=t,this.name=r,this.group=o}static fromObject(e){let t=new Server;return t.id=String(e.id),t.name=String(e.name),t.group=null,"group"in e&&null!=e.group&&(t.group=ServerGroup.fromObject(e.group)),t}getGroup(){return this.group}setGroup(e){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Instance,this.id).addParam(Param.ServerGroup,e.getId()).commit("instance/group/set").then((e=>{let t=Server.fromObject(e);return this.group=t.getGroup(),t}))}))}ungroup(e){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Instance,this.id).commit("instance/group/unset").then((e=>{let t=Server.fromObject(e);return this.group=t.getGroup(),t}))}))}}class ServerGroupList{constructor(e,t,r,o){this.id=e,this.name=t,this.network=r,this.servers=o}static fromObject(e){let t=new ServerGroupList;if(t.id=String(e.id),t.name=String(e.name),t.network=null,"network"in e&&null!=e.network&&(t.network=Network.fromObject(e.network)),t.servers=new Array,"servers"in e&&null!=e.servers&&Array.isArray(e.servers))for(let r=0;r<e.servers.length;r++)t.servers.push(Server.fromObject(e.servers[r]));return t}}class ServerGroup{constructor(e,t,r){this.id=e,this.network=t,this.name=r}getId(){return this.id}static fromObject(e){let t=new ServerGroup;return t.id=String(e.id),t.network=null,"network"in e&&null!=e.network&&(t.network=Network.fromObject(e.network)),t.name=String(e.name),t}delete(){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).addParam(Param.Instance,this.id).commit("instance/group/delete").then((()=>{}))}))}}class Player{constructor(e,t,r,o,n,i,a){this.id=e,this.creation=t,this.username=r,this.lastLogin=o,this.lastUpdated=n,this.bio=i,this.birthdate=a}asObject(){let e=JSON.parse(JSON.stringify(this));return e.lastUpdated=Util.epoch(this.getLastUpdated()),e.lastLogin=Util.epoch(this.getLastLogin()),e.birthdate=Util.epoch(this.getBirthdate()),e.creation=Util.epoch(this.getCreation()),e}getLastUpdated(){return this.lastUpdated}getLastLogin(){return this.lastLogin}getBirthdate(){return this.birthdate}getCreation(){return this.creation}static fromObject(e){let t=new Player;return"id"in e&&(t.id=String(e.id)),"creation"in e&&(t.creation=Util.date(e.creation)),"username"in e&&(t.username=null==e.username?null:String(e.username)),"lastLogin"in e&&(t.lastLogin=Util.date(e.lastLogin)),"lastUpdated"in e&&(t.lastUpdated=Util.date(e.lastUpdated)),"bio"in e&&(t.bio=null==e.bio?null:String(e.bio)),"birthdate"in e&&(t.birthdate=Util.date(e.birthdate)),t}asOwner(){return new Owner(this.id,this.creation,this.username,this.lastLogin,this.lastUpdated,this.bio,this.birthdate)}}class Owner extends Player{constructor(e,t,r,o,n,i,a){super(e,t,r,o,n,i,a)}asObject(){let e=JSON.parse(JSON.stringify(this));return e.lastUpdated=Util.epoch(this.getLastUpdated()),e.lastLogin=Util.epoch(this.getLastLogin()),e.birthdate=Util.epoch(this.getBirthdate()),e.creation=Util.epoch(this.getCreation()),e}getNetworks(){return __awaiter(this,void 0,void 0,(function*(){return yield(new Call).commit("network/list/").then((e=>{if(Array.isArray(e)){let t=new Array;for(let r=0;r<e.length;r++)t.push(Network.fromObject(e[r]));return t}throw new Error("Invalid type")}))}))}createNetwork(e,t,r,o){return __awaiter(this,void 0,void 0,(function*(){return r=Util.gameVal(r),o=Util.platformVal(o),yield(new Call).addParam(Param.Name,e).addParam(Param.Cname,t).addParam(Param.Game,r).addParam(Param.Platform,o).commit("network/create/").then((e=>Network.fromObject(e)))}))}}class Context{getNetwork(){return this.network}setNetwork(e){if("string"==typeof e){let t=this;Core.getNetwork(e).then((e=>{t.network=e}))}else this.network=e}}class Util{static dec2hex(e){return e.toString(16).padStart(2,"0")}static generateGibberish(e){var t=new Uint8Array((e||40)/2);return window.crypto.getRandomValues(t),Array.from(t,Util.dec2hex).join("")}static shortLengthToLong(e){let t="",r=Math.floor(16*Math.random());r%2<=0&&(r+=1);let o=16+r;t=Number(e*r).toString(2);let n="";for(let e=0;e<o;e++)n+=e==o-1?String(e)+t:String(e)+t+"!@#";return btoa(n)}static longLengthToShort(e){let t=atob(e).split("!@#"),r=parseInt(t[0].substring(1,t[0].length-1),2)/(t.length-16);return Math.floor(2*r)}static epoch(e){return null==e?null:e.getTime()/1e3}static date(e){if(null!=e&&0!=e){let t=new Date(0);return t.setUTCSeconds(e),t}return null}static gameVal(e){if("string"==typeof e)if(isNaN(Number(e)))switch(e=String(e).toLowerCase(),!0){case["mc","minecraft"].includes(e):e=Game.Minecraft;break;case["mc bedrock","bedrock","minecraft bedrock","minecraft_bedrock","minecraftbedrock"].includes(e):e=Game.MinecraftBedrock,console.log(e);break;case["se","spaceengineers","space engineers"].includes(e):e=Game.SpaceEngineers;break;default:e=Game.Unknown}else e=Number(e);return Game.SpaceEngineers,e<Game.Unknown&&(e=Game.Unknown),e}static platformVal(e){if("string"==typeof e)if(isNaN(Number(e)))switch(e=String(e).toLowerCase(),!0){case["mojang"].includes(e):e=Platform.Mojang;break;case["xbox","microsoft"].includes(e):e=Platform.Xbox;break;case["google","stadia"].includes(e):e=Platform.Stadia;break;case["steam","valve"].includes(e):e=Platform.Steam;break;case["discord","discord-o!"].includes(e):e=Platform.Discord;break;case["epic","epicgames"].includes(e):e=Platform.EpicGames;break;default:e=Platform.Unknown}else e=Number(e);return Platform.Discord,e<Platform.Unknown&&(e=Platform.Unknown),e}}